name: teste ze
run-name: ${{ github.actor }} is testing allure 🚀

on: [push]

jobs:
  Setup:
    runs-on: ubuntu-latest
    outputs:
      java_version: '17'
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

  Build:
    runs-on: ubuntu-latest
    needs: Setup
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Build do projeto
        run: mvn clean package -f pom.xml

  Testes:
    runs-on: ubuntu-latest
    needs: Build
    strategy:
      matrix:
        type: [health, contrato, funcional]
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'oracle'
          java-version: 17

      - name: Executar testes (${{ matrix.type }})
        run: mvn test -P${{ matrix.type }} -Dallure.results.directory=target/allure-results/${{ matrix.type }}

      - name: Verificar conteúdo de allure-results
        run: ls -R target/allure-results/${{ matrix.type }} || echo "Nenhum resultado encontrado em allure-results/${{ matrix.type }}"

      - name: Upload test results (${{ matrix.type }})
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.type }}
          path: target/allure-results/${{ matrix.type }}

  Reports:
    runs-on: ubuntu-latest
    needs: Testes
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'oracle'
          java-version: 17

      - name: Baixar todos os resultados dos testes
        uses: actions/download-artifact@v4
        with:
          path: target/allure-results/

      - name: Unificar resultados
        run: |
          mkdir -p allure-results
          cp -r target/allure-results/results-health/* target/allure-results/ || true
          cp -r target/allure-results/results-contrato/* target/allure-results/ || true
          cp -r target/allure-results/results-funcional/* target/allure-results/ || true

      - name: Gerar relatório Allure
        run: mvn allure:report

      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/site/allure-maven-plugin/

  DeployReport:
    runs-on: ubuntu-latest
    needs: Reports
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Baixar Allure Report
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: gh-pages

      - name: Publicar relatório no GitHub Pages
        run: |
          cd gh-pages
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Atualização do relatório Allure"
          git push origin gh-pages
